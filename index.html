<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>CourierMLG</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input[type="text"] { width: 100%; padding: 10px; font-size: 16px; }
    .autocomplete-wrapper {
      position: relative;
    }
    ul.suggestions {
      list-style: none;
      margin: 0;
      padding: 0;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      position: absolute;
      width: 100%;
      background: #fff;
      z-index: 10;
    }
    ul.suggestions li {
      padding: 10px;
      cursor: pointer;
    }
    ul.suggestions li:hover {
      background: #f0f0f0;
    }
    #resultBox {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      background: #f9f9f9;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
    .result-key {
      font-weight: bold;
      color: #333;
    }
    .result-value {
      color: #555;
      text-align: right;
    }
  </style>
</head>
<body>
  <h2>Tujuan</h2>
  <div class="autocomplete-wrapper">
    <input type="text" id="tujuanInput" placeholder="Ketik tujuan (provinsi, kabupaten, kecamatan)...">
    <ul class="suggestions" id="suggestions" hidden></ul>
  </div>
  <div id="resultBox"></div>

  <script>
    const input = document.getElementById('tujuanInput');
    const suggestionBox = document.getElementById('suggestions');
    const resultBox = document.getElementById('resultBox');
    let data = [];

    fetch('https://raw.githubusercontent.com/kiose7/ongkircrm/main/autodata.lst')
      .then(res => res.text())
      .then(text => {
        data = text.split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(line => {
            const parts = line.split(',');
            const index = parts[0];
            const provinsi = parts[1];
            const kabupaten = parts[2];
            const kecamatan = parts.slice(3).join(',');
            return {
              label: `${provinsi} - ${kabupaten} - ${kecamatan}`,
              provinsi,
              index
            };
          });
      });

    input.addEventListener('input', () => {
      const val = input.value.toLowerCase();
      const filtered = data.filter(d => d.label.toLowerCase().includes(val));
      renderSuggestions(filtered);
    });

    function renderSuggestions(list) {
      suggestionBox.innerHTML = '';
      if (list.length === 0) {
        suggestionBox.hidden = true;
        return;
      }
      list.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item.label;
        li.onclick = () => selectItem(item);
        suggestionBox.appendChild(li);
      });
      suggestionBox.hidden = false;
    }

    function selectItem(item) {
      input.value = item.label;
      suggestionBox.hidden = true;
      resultBox.innerHTML = '<em>Memuat data ongkir...</em>';

      const url = `https://script.google.com/macros/s/AKfycby3xAhYR-NrT9NR6N56O1ZUIUhLb4V1ufxemPSZ15n2EquTDrhdXnekYXhI5UG7ZhqoVw/exec?provinsi=${encodeURIComponent(item.provinsi)}&index=${item.index}`;

      fetch(url)
        .then(res => res.json())
        .then(json => {
          resultBox.innerHTML = '';

          const headers = [
            "ADM", "KEC", "POS Reg", "Wahana Xpress", "Wahana Kargo", "SAP Xpress", "SAP Kargo", "Lion Reg", "Lion JagoPack",
            "Lion BigPack", "JNT", "JNE", "JNE JTR", "ID Xpress", "ID Trucking", "SiCepat Reg", "SiCepat Gokil", "NCS Reg", "Estimasi"
          ];

          for (let i = 2; i < headers.length - 1; i++) {
            const row = document.createElement('div');
            row.className = 'result-row';

            const keyDiv = document.createElement('div');
            keyDiv.className = 'result-key';
            keyDiv.textContent = headers[i];

            const valueDiv = document.createElement('div');
            valueDiv.className = 'result-value';
            const valueText = isNaN(json[i]) ? json[i] : parseInt(json[i]).toLocaleString('id-ID');
            valueDiv.textContent = valueText;

            row.appendChild(keyDiv);
            row.appendChild(valueDiv);
            resultBox.appendChild(row);
          }

          const estRow = document.createElement('div');
          estRow.className = 'result-row';

          const estKey = document.createElement('div');
          estKey.className = 'result-key';
          estKey.textContent = headers[headers.length - 1];

          const estVal = document.createElement('div');
          estVal.className = 'result-value';
          estVal.textContent = json[json.length - 1];

          estRow.appendChild(estKey);
          estRow.appendChild(estVal);
          resultBox.appendChild(estRow);
        })
        .catch(err => {
          resultBox.innerHTML = '<span style="color: red">Gagal mengambil data ongkir.</span>';
          console.error(err);
        });
    }
  </script>
</body>
</html>
